name: OTA Update

on:
  # Manual trigger via GitHub UI and CLI
  workflow_dispatch:
    inputs:
      channel:
        description: 'Update channel'
        required: true
        type: choice
        options:
          - staging
          - preview
          - production
        default: 'staging'
      skip_ci:
        description: 'Skip CI checks (emergency only)'
        required: false
        type: boolean
        default: false
      rollback:
        description: 'Rollback to previous version'
        required: false
        type: boolean
        default: false
      rollback_id:
        description: 'Specific deployment ID to rollback to (if not latest)'
        required: false
        type: string

permissions:
  contents: read
  actions: write

jobs:
  # Pre-flight checks before publishing
  preflight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.should-publish.outputs.result }}
      channel: ${{ steps.determine-channel.outputs.channel }}
      version: ${{ steps.get-version.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Determine channel based on trigger
        id: determine-channel
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "channel=production" >> $GITHUB_OUTPUT
          else
            echo "channel=${{ github.event.inputs.channel }}" >> $GITHUB_OUTPUT
          fi

      - name: Get app version
        id: get-version
        run: |
          VERSION=$(grep -m1 '"version"' apps/mobile/app.config.ts | cut -d'"' -f4)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "App version: $VERSION"

      - name: Check if should publish
        id: should-publish
        run: |
          CHANNEL="${{ steps.determine-channel.outputs.channel }}"
          SKIP_CI="${{ github.event.inputs.skip_ci }}"

          echo "Channel: $CHANNEL"
          echo "Skip CI: ${SKIP_CI:-false}"

          # Always publish (CI checks happen in next job if not skipped)
          echo "result=true" >> $GITHUB_OUTPUT

  # Quality checks (can be skipped with skip_ci input)
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_ci != 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 10.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'pnpm'

      - name: Get pnpm store directory
        id: pnpm-store
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build workspace packages
        run: pnpm -w --filter @nv-internal/prisma-client --filter @nv-internal/validation run build

      - name: TypeScript check
        run: pnpm -w tsc -b apps/mobile/tsconfig.json --pretty false

      - name: Biome lint
        run: pnpm biome lint apps/mobile/

      - name: Biome check
        run: pnpm biome check apps/mobile/

      - name: Run mobile tests (if any)
        run: |
          if [ -d "apps/mobile/__tests__" ]; then
            pnpm --filter @nv-internal/mobile test --passWithNoTests
          fi
        continue-on-error: true

  # Publish OTA update
  publish-ota:
    name: Publish OTA Update
    runs-on: ubuntu-latest
    needs: [preflight, quality-checks]
    if: |
      needs.preflight.outputs.should_publish == 'true' &&
      (github.event.inputs.skip_ci == 'true' || success())

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 10.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'pnpm'

      - name: Get pnpm store directory
        id: pnpm-store
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          expo-cache: true
          eas-cache: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build workspace packages
        run: pnpm -w --filter @nv-internal/prisma-client --filter @nv-internal/validation run build

      - name: Sync and increment build number
        id: increment
        if: github.event.inputs.rollback != 'true'
        env:
          GH_TOKEN: ${{ secrets.BUILD_NUMBER_PAT }}
        run: |
          echo "ðŸ“ˆ Syncing build number with EAS and incrementing..."

          # Get current GitHub build number
          GH_BUILD=$(gh variable get BUILD_NUMBER --repo ${{ github.repository }} 2>/dev/null || echo "0")
          echo "GitHub BUILD_NUMBER: '$GH_BUILD'"

          # Get EAS build numbers - improved extraction
          cd apps/mobile

          # Extract iOS buildNumber (format: "buildNumber: X" or similar)
          EAS_IOS_RAW=$(eas build:version:get -p ios 2>/dev/null || echo "")
          echo "Raw EAS iOS output: '$EAS_IOS_RAW'"

          # Try to extract the last number from the output (most likely to be version)
          EAS_IOS=$(echo "$EAS_IOS_RAW" | grep -o '[0-9]\+' | tail -1)
          EAS_IOS=${EAS_IOS:-0}

          # Extract Android versionCode (format: "versionCode: X" or similar)
          EAS_ANDROID_RAW=$(eas build:version:get -p android 2>/dev/null || echo "")
          echo "Raw EAS Android output: '$EAS_ANDROID_RAW'"

          # Try to extract the last number from the output (most likely to be version)
          EAS_ANDROID=$(echo "$EAS_ANDROID_RAW" | grep -o '[0-9]\+' | tail -1)
          EAS_ANDROID=${EAS_ANDROID:-0}

          cd ..

          echo "EAS iOS buildNumber: '$EAS_IOS'"
          echo "EAS Android versionCode: '$EAS_ANDROID'"

          # Ensure all variables are numeric, default to 0 if not
          if ! [[ "$GH_BUILD" =~ ^[0-9]+$ ]]; then GH_BUILD=0; fi
          if ! [[ "$EAS_IOS" =~ ^[0-9]+$ ]]; then EAS_IOS=0; fi
          if ! [[ "$EAS_ANDROID" =~ ^[0-9]+$ ]]; then EAS_ANDROID=0; fi

          # Find the maximum build number across all sources (never decrease)
          MAX_BUILD=$GH_BUILD
          if [ "$EAS_IOS" -gt "$MAX_BUILD" ]; then MAX_BUILD=$EAS_IOS; fi
          if [ "$EAS_ANDROID" -gt "$MAX_BUILD" ]; then MAX_BUILD=$EAS_ANDROID; fi

          # Increment from the maximum
          NEW_BUILD=$((MAX_BUILD + 1))
          echo "Maximum existing build: $MAX_BUILD"
          echo "New unified build number: $NEW_BUILD"

          # Update GitHub variable
          gh variable set BUILD_NUMBER --body "$NEW_BUILD" --repo ${{ github.repository }}

          echo "build_number=$NEW_BUILD" >> $GITHUB_OUTPUT
          echo "âœ… Build number synchronized and incremented to $NEW_BUILD"

      - name: Handle rollback
        id: rollback
        working-directory: apps/mobile
        if: github.event.inputs.rollback == 'true'
        run: |
          CHANNEL="${{ needs.preflight.outputs.channel }}"
          ROLLBACK_ID="${{ github.event.inputs.rollback_id }}"

          echo "Rolling back channel: $CHANNEL"

          if [ -n "$ROLLBACK_ID" ]; then
            echo "Rolling back to specific deployment: $ROLLBACK_ID"
            # Note: This would require EAS CLI support or manual API call
            # For now, log the rollback request for manual handling
            echo "rollback_id=$ROLLBACK_ID" >> $GITHUB_OUTPUT
          else
            echo "Rolling back to latest stable version"
            echo "rollback_id=latest" >> $GITHUB_OUTPUT
          fi

      - name: Validate required environment variables
        id: validate-env
        run: |
          echo "ðŸ” Validating environment variables..."

          MISSING_VARS=()

          # Check critical secrets (without exposing values)
          if [ -z "${{ secrets.EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY }}" ]; then
            MISSING_VARS+=("EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY")
          fi

          if [ -z "${{ secrets.EXPO_PUBLIC_GOOGLE_MAPS_API_KEY_IOS }}" ]; then
            MISSING_VARS+=("EXPO_PUBLIC_GOOGLE_MAPS_API_KEY_IOS")
          fi

          if [ -z "${{ secrets.EXPO_PUBLIC_GOOGLE_MAPS_API_KEY_ANDROID }}" ]; then
            MISSING_VARS+=("EXPO_PUBLIC_GOOGLE_MAPS_API_KEY_ANDROID")
          fi

          if [ -z "${{ secrets.EXPO_PUBLIC_POSTHOG_API_KEY }}" ]; then
            MISSING_VARS+=("EXPO_PUBLIC_POSTHOG_API_KEY")
          fi

          # Report missing variables
          if [ ${#MISSING_VARS[@]} -gt 0 ]; then
            echo "âŒ ERROR: Missing required GitHub Secrets:"
            for var in "${MISSING_VARS[@]}"; do
              echo "  - $var"
            done
            echo ""
            echo "Please configure these secrets in GitHub Settings -> Secrets and variables -> Actions"
            exit 1
          fi

          echo "âœ… All required secrets are configured"

          # Log configured env var names (without values)
          echo "ðŸ“‹ Environment variables that will be set:"
          echo "  - EXPO_PUBLIC_ENV"
          echo "  - EXPO_PUBLIC_API_URL"
          echo "  - EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY"
          echo "  - EXPO_PUBLIC_GOOGLE_MAPS_API_KEY_IOS"
          echo "  - EXPO_PUBLIC_GOOGLE_MAPS_API_KEY_ANDROID"
          echo "  - EXPO_PUBLIC_POSTHOG_API_KEY"
          echo "  - EXPO_PUBLIC_POSTHOG_HOST"
          echo "  - EXPO_PUBLIC_POSTHOG_ENABLED"
          echo "  - EXPO_PUBLIC_BUILD_NUMBER"
          echo "  - BUILD_NUMBER"

      - name: Configure channel-specific environment
        id: configure-env
        run: |
          CHANNEL="${{ needs.preflight.outputs.channel }}"

          echo "âš™ï¸  Configuring environment for channel: $CHANNEL"

          # Set channel-specific environment variables
          if [ "$CHANNEL" == "production" ]; then
            echo "EXPO_PUBLIC_ENV=production" >> $GITHUB_ENV
            echo "EXPO_PUBLIC_API_URL=https://nv-internal-api.vercel.app" >> $GITHUB_ENV
            echo "EXPO_PUBLIC_POSTHOG_HOST=https://app.posthog.com" >> $GITHUB_ENV
            echo "EXPO_PUBLIC_POSTHOG_ENABLED=true" >> $GITHUB_ENV
            echo "env_type=production" >> $GITHUB_OUTPUT
          elif [ "$CHANNEL" == "staging" ] || [ "$CHANNEL" == "preview" ]; then
            echo "EXPO_PUBLIC_ENV=staging" >> $GITHUB_ENV
            echo "EXPO_PUBLIC_API_URL=https://nv-internal-staging.vercel.app" >> $GITHUB_ENV
            echo "EXPO_PUBLIC_POSTHOG_HOST=https://app.posthog.com" >> $GITHUB_ENV
            echo "EXPO_PUBLIC_POSTHOG_ENABLED=true" >> $GITHUB_ENV
            echo "env_type=staging" >> $GITHUB_OUTPUT
          else
            echo "âŒ ERROR: Unknown channel '$CHANNEL'"
            echo "Valid channels: production, staging, preview"
            exit 1
          fi

          # Set common environment variables from secrets
          echo "EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY=${{ secrets.EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY }}" >> $GITHUB_ENV
          echo "EXPO_PUBLIC_GOOGLE_MAPS_API_KEY_IOS=${{ secrets.EXPO_PUBLIC_GOOGLE_MAPS_API_KEY_IOS }}" >> $GITHUB_ENV
          echo "EXPO_PUBLIC_GOOGLE_MAPS_API_KEY_ANDROID=${{ secrets.EXPO_PUBLIC_GOOGLE_MAPS_API_KEY_ANDROID }}" >> $GITHUB_ENV
          echo "EXPO_PUBLIC_POSTHOG_API_KEY=${{ secrets.EXPO_PUBLIC_POSTHOG_API_KEY }}" >> $GITHUB_ENV

          # Set OTA build number so app can display it
          echo "EXPO_PUBLIC_BUILD_NUMBER=${{ steps.increment.outputs.build_number }}" >> $GITHUB_ENV

          echo "âœ… Environment configured for $CHANNEL"

      - name: Publish OTA update
        id: publish
        working-directory: apps/mobile
        if: github.event.inputs.rollback != 'true'
        env:
          BUILD_NUMBER: ${{ steps.increment.outputs.build_number }}
          # Explicitly pass all environment variables for OTA bundle
          EXPO_PUBLIC_ENV: ${{ env.EXPO_PUBLIC_ENV }}
          EXPO_PUBLIC_API_URL: ${{ env.EXPO_PUBLIC_API_URL }}
          EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ env.EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          EXPO_PUBLIC_GOOGLE_MAPS_API_KEY_IOS: ${{ env.EXPO_PUBLIC_GOOGLE_MAPS_API_KEY_IOS }}
          EXPO_PUBLIC_GOOGLE_MAPS_API_KEY_ANDROID: ${{ env.EXPO_PUBLIC_GOOGLE_MAPS_API_KEY_ANDROID }}
          EXPO_PUBLIC_POSTHOG_API_KEY: ${{ env.EXPO_PUBLIC_POSTHOG_API_KEY }}
          EXPO_PUBLIC_POSTHOG_HOST: ${{ env.EXPO_PUBLIC_POSTHOG_HOST }}
          EXPO_PUBLIC_POSTHOG_ENABLED: ${{ env.EXPO_PUBLIC_POSTHOG_ENABLED }}
          EXPO_PUBLIC_BUILD_NUMBER: ${{ env.EXPO_PUBLIC_BUILD_NUMBER }}
        run: |
          CHANNEL="${{ needs.preflight.outputs.channel }}"
          VERSION="${{ needs.preflight.outputs.version }}"
          BUILD="${{ steps.increment.outputs.build_number }}"

          echo "Publishing OTA to channel: $CHANNEL"
          echo "App version: $VERSION"
          echo "Build number: $BUILD"
          echo "Environment: ${EXPO_PUBLIC_ENV}"
          echo "API URL: ${EXPO_PUBLIC_API_URL}"

          # Verify env vars are set before publishing
          if [ -z "$EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY" ] || [ -z "$EXPO_PUBLIC_API_URL" ]; then
            echo "âŒ ERROR: Critical environment variables not set"
            exit 1
          fi

          # Publish to the specified channel using EAS Update
          # All EXPO_PUBLIC_* environment variables will be bundled into the update
          eas update --channel "$CHANNEL" --message "Deploy v$VERSION ($BUILD) to $CHANNEL" --non-interactive

          echo "âœ… OTA published successfully"
          echo "channel=$CHANNEL" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD" >> $GITHUB_OUTPUT

      - name: Display rollback info
        if: github.event.inputs.rollback == 'true'
        run: |
          echo "## âš ï¸ Rollback Info" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Channel**: ${{ needs.preflight.outputs.channel }}" >> $GITHUB_STEP_SUMMARY
          echo "**App Version**: ${{ needs.preflight.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To complete manual rollback:" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to https://expo.dev" >> $GITHUB_STEP_SUMMARY
          echo "2. Select your project" >> $GITHUB_STEP_SUMMARY
          echo "3. Click 'Updates' tab" >> $GITHUB_STEP_SUMMARY
          echo "4. Find the bad deployment" >> $GITHUB_STEP_SUMMARY
          echo "5. Click 'Rollback' â†’ Select previous version" >> $GITHUB_STEP_SUMMARY

      - name: Display OTA info
        if: github.event.inputs.rollback != 'true'
        run: |
          echo "## âœ… OTA Update Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Channel**: ${{ needs.preflight.outputs.channel }}" >> $GITHUB_STEP_SUMMARY
          echo "**App Version**: ${{ needs.preflight.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Number**: ${{ steps.publish.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Published At**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps**:" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor deployment: https://expo.dev" >> $GITHUB_STEP_SUMMARY
          echo "- Check PostHog for errors: https://us.posthog.com" >> $GITHUB_STEP_SUMMARY
          echo "- Users will receive update on next app launch" >> $GITHUB_STEP_SUMMARY

  # Notification (optional)
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [preflight, publish-ota]
    if: |
      always() &&
      github.event.inputs.skip_ci != 'true'

    env:
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

    steps:
      - name: Prepare notification
        id: notification
        run: |
          CHANNEL="${{ needs.preflight.outputs.channel }}"
          VERSION="${{ needs.preflight.outputs.version }}"
          STATUS="${{ needs.publish-ota.result }}"

          if [ "$STATUS" == "success" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="succeeded"
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="failed"
          fi

          echo "emoji=$STATUS_EMOJI" >> $GITHUB_OUTPUT
          echo "status=$STATUS_TEXT" >> $GITHUB_OUTPUT
          echo "message=OTA Update $STATUS_TEXT for $CHANNEL (v$VERSION)" >> $GITHUB_OUTPUT

      - name: Send to Slack
        if: env.SLACK_WEBHOOK != '' && needs.publish-ota.result == 'success'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "${{ steps.notification.outputs.emoji }} ${{ steps.notification.outputs.message }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*${{ steps.notification.outputs.emoji }} OTA Update Published*\n\nChannel: `${{ needs.preflight.outputs.channel }}`\nVersion: `${{ needs.preflight.outputs.version }}`\nTime: <!date^${{ job.created_at }}^{date_num} {time_secs}|${{ job.created_at }}>"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View on EAS"
                      },
                      "url": "https://expo.dev"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Logs"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Send to Discord
        if: env.DISCORD_WEBHOOK != '' && needs.publish-ota.result == 'success'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK }}
          description: |
            Channel: ${{ needs.preflight.outputs.channel }}
            Version: ${{ needs.preflight.outputs.version }}
          title: ${{ steps.notification.outputs.emoji }} OTA Update Published
          color: ${{ needs.publish-ota.result == 'success' && 0x28a745 || 0xdc3545 }}

  # Post-publish steps
  post-publish:
    name: Post-Publish Steps
    runs-on: ubuntu-latest
    needs: [preflight, publish-ota]
    if: needs.publish-ota.result == 'success'
    continue-on-error: true

    steps:
      - name: Create deployment record
        run: |
          echo "## ðŸ“‹ OTA Deployment Record" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Channel**: ${{ needs.preflight.outputs.channel }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.preflight.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Monitoring**:" >> $GITHUB_STEP_SUMMARY
          echo "- [EAS Dashboard](https://expo.dev)" >> $GITHUB_STEP_SUMMARY
          echo "- [PostHog Analytics](https://us.posthog.com)" >> $GITHUB_STEP_SUMMARY

      - name: Log deployment
        run: |
          echo "OTA Deployment Summary:"
          echo "  Channel: ${{ needs.preflight.outputs.channel }}"
          echo "  Version: ${{ needs.preflight.outputs.version }}"
          echo "  Timestamp: $(date)"
          echo "  URL: https://expo.dev"
