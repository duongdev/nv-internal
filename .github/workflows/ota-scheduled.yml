name: Scheduled OTA Update

# Publish OTA updates on a schedule (DISABLED - manual only)
# To enable automatic nightly OTA: uncomment the schedule section below
on:
  # schedule:
  #   # Every weekday at 2 AM UTC (9 AM UTC+7 Vietnam time)
  #   - cron: '0 2 * * 1-5'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      skip_if_no_changes:
        description: 'Skip if no code changes since last OTA'
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  actions: write

jobs:
  check-changes:
    name: Check for Changes
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 50

      - name: Check for changes in mobile app
        id: check
        run: |
          # Get the latest successful OTA deployment from git history
          # For now, always publish (can be improved with deployment tracking)
          echo "has_changes=true" >> $GITHUB_OUTPUT

          # In production, you might:
          # 1. Store last deployment commit in a file
          # 2. Compare current HEAD with that commit
          # 3. Only publish if mobile/ directory changed
          #
          # Example:
          # git log --oneline --all -- apps/mobile/ | head -1
          # git diff HEAD~1 -- apps/mobile/ | wc -l

  publish:
    name: Publish Scheduled OTA
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.has_changes == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 10.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'pnpm'

      - name: Get pnpm store directory
        id: pnpm-store
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build workspace packages
        run: pnpm -w --filter @nv-internal/prisma-client --filter @nv-internal/validation run build

      - name: Run quality checks
        run: |
          echo "Running quality checks..."
          pnpm biome check apps/mobile/ --write

      - name: Sync and increment build number
        id: increment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“ˆ Syncing build number with EAS and incrementing..."

          # Get current GitHub build number
          GH_BUILD=$(gh variable get BUILD_NUMBER --repo ${{ github.repository }} 2>/dev/null || echo "0")
          echo "GitHub BUILD_NUMBER: '$GH_BUILD'"

          # Get EAS build numbers - improved extraction
          cd apps/mobile

          # Extract iOS buildNumber (format: "buildNumber: X" or similar)
          EAS_IOS_RAW=$(eas build:version:get -p ios 2>/dev/null || echo "")
          echo "Raw EAS iOS output: '$EAS_IOS_RAW'"

          # Try to extract the last number from the output (most likely to be version)
          EAS_IOS=$(echo "$EAS_IOS_RAW" | grep -o '[0-9]\+' | tail -1)
          EAS_IOS=${EAS_IOS:-0}

          # Extract Android versionCode (format: "versionCode: X" or similar)
          EAS_ANDROID_RAW=$(eas build:version:get -p android 2>/dev/null || echo "")
          echo "Raw EAS Android output: '$EAS_ANDROID_RAW'"

          # Try to extract the last number from the output (most likely to be version)
          EAS_ANDROID=$(echo "$EAS_ANDROID_RAW" | grep -o '[0-9]\+' | tail -1)
          EAS_ANDROID=${EAS_ANDROID:-0}

          cd ..

          echo "EAS iOS buildNumber: '$EAS_IOS'"
          echo "EAS Android versionCode: '$EAS_ANDROID'"

          # Ensure all variables are numeric, default to 0 if not
          if ! [[ "$GH_BUILD" =~ ^[0-9]+$ ]]; then GH_BUILD=0; fi
          if ! [[ "$EAS_IOS" =~ ^[0-9]+$ ]]; then EAS_IOS=0; fi
          if ! [[ "$EAS_ANDROID" =~ ^[0-9]+$ ]]; then EAS_ANDROID=0; fi

          # Find the maximum build number across all sources (never decrease)
          MAX_BUILD=$GH_BUILD
          if [ "$EAS_IOS" -gt "$MAX_BUILD" ]; then MAX_BUILD=$EAS_IOS; fi
          if [ "$EAS_ANDROID" -gt "$MAX_BUILD" ]; then MAX_BUILD=$EAS_ANDROID; fi

          # Increment from the maximum
          NEW_BUILD=$((MAX_BUILD + 1))
          echo "Maximum existing build: $MAX_BUILD"
          echo "New unified build number: $NEW_BUILD"

          # Update GitHub variable
          gh variable set BUILD_NUMBER --body "$NEW_BUILD" --repo ${{ github.repository }}

          echo "build_number=$NEW_BUILD" >> $GITHUB_OUTPUT
          echo "âœ… Build number synchronized and incremented to $NEW_BUILD"

      - name: Publish OTA to staging
        working-directory: apps/mobile
        env:
          BUILD_NUMBER: ${{ steps.increment.outputs.build_number }}
        run: |
          echo "Publishing nightly OTA to staging..."
          VERSION=$(grep -m1 '"version"' app.config.ts | cut -d'"' -f4)
          BUILD="${{ steps.increment.outputs.build_number }}"

          eas update --channel staging --message "Nightly build v$VERSION ($BUILD) $(date -u +'%Y-%m-%d')" --non-interactive
          echo "âœ… Staging OTA published"

      - name: Create summary
        run: |
          VERSION=$(grep -m1 '"version"' apps/mobile/app.config.ts | cut -d'"' -f4)
          BUILD="${{ steps.increment.outputs.build_number }}"

          echo "## ðŸŒ™ Nightly OTA Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Channel**: staging" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Build Number**: $BUILD" >> $GITHUB_STEP_SUMMARY
          echo "**Time**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "QA team will receive nightly build on next app launch." >> $GITHUB_STEP_SUMMARY
