# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

default_platform(:ios)

platform :ios do
  desc "Load App Store Connect API Key"
  lane :load_asc_api_key do
    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_KEY_CONTENT"],
      in_house: false
    )
  end

  desc "Increment build number"
  lane :increment_build_number_lane do
    build_number = ENV["BUILD_NUMBER"] || "1"
    UI.message("Using build number: #{build_number}")

    # Export for expo prebuild
    ENV["BUILD_NUMBER"] = build_number
  end

  desc "Run Expo Prebuild for iOS"
  lane :run_prebuild do
    UI.message("Running expo prebuild for iOS...")
    sh("npx expo prebuild --clean --platform ios")
  end

  desc "Build and upload to TestFlight (Production)"
  lane :build_upload_testflight do
    api_key = load_asc_api_key
    setup_ci if ENV['CI']

    increment_build_number_lane
    run_prebuild

    # Get code signing - try readonly first, generate if missing
    begin
      match(
        type: 'appstore',
        readonly: true,
        verbose: true,
        api_key: api_key,
        keychain_name: ENV['CI'] ? "fastlane_tmp_keychain" : nil,
        keychain_password: ""
      )
    rescue => ex
      if ex.message.include?("No code signing identity found") || ex.message.include?("No matching provisioning profiles found")
        UI.important("No certificates or provisioning profiles found, generating new ones...")
        match(
          type: 'appstore',
          readonly: false,
          verbose: true,
          api_key: api_key,
          keychain_name: ENV['CI'] ? "fastlane_tmp_keychain" : nil,
          keychain_password: ""
        )
      else
        raise ex
      end
    end

    # Build app
    build_app(
      workspace: "ios/NamVitInternal.xcworkspace",
      scheme: "NamVitInternal",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "nvinternal.ipa",
      clean: true,
      xcargs: "DEVELOPMENT_TEAM=9F77J83SKT CODE_SIGN_STYLE=Manual PROVISIONING_PROFILE_SPECIFIER='match AppStore vn.dienlanhnamviet.internal'",
      export_xcargs: "-allowProvisioningUpdates",
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "vn.dienlanhnamviet.internal" => "match AppStore vn.dienlanhnamviet.internal"
        },
        signingStyle: "manual",
        teamID: "9F77J83SKT"
      }
    )

    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      distribute_external: false
    )

    UI.success("✅ Successfully uploaded build to TestFlight!")
  end

  desc "Build for staging/preview (Ad Hoc)"
  lane :build_staging do
    api_key = load_asc_api_key
    setup_ci if ENV['CI']

    increment_build_number_lane
    run_prebuild

    # Get code signing - try readonly first, generate if missing
    begin
      match(
        type: 'adhoc',
        readonly: true,
        verbose: true,
        api_key: api_key,
        keychain_name: ENV['CI'] ? "fastlane_tmp_keychain" : nil,
        keychain_password: ""
      )
    rescue => ex
      if ex.message.include?("No code signing identity found") || ex.message.include?("No matching provisioning profiles found")
        UI.important("No certificates or provisioning profiles found, generating new ones...")
        match(
          type: 'adhoc',
          readonly: false,
          verbose: true,
          api_key: api_key,
          keychain_name: ENV['CI'] ? "fastlane_tmp_keychain" : nil,
          keychain_password: ""
        )
      else
        raise ex
      end
    end

    build_app(
      workspace: "ios/NamVitInternal.xcworkspace",
      scheme: "NamVitInternal",
      export_method: "ad-hoc",
      output_directory: "./build",
      output_name: "nvinternal-staging.ipa",
      clean: true,
      xcargs: "DEVELOPMENT_TEAM=9F77J83SKT CODE_SIGN_STYLE=Manual PROVISIONING_PROFILE_SPECIFIER='match AdHoc vn.dienlanhnamviet.internal'",
      export_xcargs: "-allowProvisioningUpdates",
      export_options: {
        method: "ad-hoc",
        provisioningProfiles: {
          "vn.dienlanhnamviet.internal" => "match AdHoc vn.dienlanhnamviet.internal"
        },
        signingStyle: "manual",
        teamID: "9F77J83SKT"
      }
    )

    UI.success("✅ Successfully built staging IPA!")
  end
end

platform :android do
  desc "Increment build number"
  lane :increment_build_number_lane do
    build_number = ENV["BUILD_NUMBER"] || "1"
    UI.message("Using build number: #{build_number}")

    # Export for expo prebuild
    ENV["BUILD_NUMBER"] = build_number
  end

  desc "Run Expo Prebuild for Android"
  lane :run_prebuild do
    UI.message("Running expo prebuild for Android...")
    sh("npx expo prebuild --clean --platform android")
  end

  desc "Build and upload to Play Store (Internal Track)"
  lane :build_upload_playstore do
    increment_build_number_lane
    run_prebuild

    # Build AAB
    gradle(
      task: "bundle",
      build_type: "Release",
      project_dir: "android/",
      properties: {
        "android.injected.signing.store.file" => File.expand_path("../@duongdev__nv-internal.jks"),
        "android.injected.signing.store.password" => ENV["ANDROID_KEYSTORE_PASSWORD"],
        "android.injected.signing.key.alias" => ENV["ANDROID_KEY_ALIAS"] || "nv-internal",
        "android.injected.signing.key.password" => ENV["ANDROID_KEY_PASSWORD"]
      }
    )

    # Upload to Play Store
    upload_to_play_store(
      track: 'internal',
      aab: 'android/app/build/outputs/bundle/release/app-release.aab',
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )

    UI.success("✅ Successfully uploaded build to Play Store Internal Track!")
  end

  desc "Build APK for testing"
  lane :build_apk do
    increment_build_number_lane
    run_prebuild

    gradle(
      task: "assemble",
      build_type: "Release",
      project_dir: "android/",
      properties: {
        "android.injected.signing.store.file" => File.expand_path("../@duongdev__nv-internal.jks"),
        "android.injected.signing.store.password" => ENV["ANDROID_KEYSTORE_PASSWORD"],
        "android.injected.signing.key.alias" => ENV["ANDROID_KEY_ALIAS"] || "nv-internal",
        "android.injected.signing.key.password" => ENV["ANDROID_KEY_PASSWORD"]
      }
    )

    UI.success("✅ Successfully built APK!")
  end
end
