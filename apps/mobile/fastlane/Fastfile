# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

default_platform(:ios)

platform :ios do
  desc "Load App Store Connect API Key"
  lane :load_asc_api_key do
    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_KEY_CONTENT"],
      in_house: false
    )
  end

  desc "Increment build number"
  lane :increment_build_number_lane do
    build_number = ENV["BUILD_NUMBER"] || "1"
    UI.message("Using build number: #{build_number}")

    # Export for expo prebuild
    ENV["BUILD_NUMBER"] = build_number
  end

  desc "Run Expo Prebuild for iOS"
  lane :run_prebuild do
    UI.message("Running expo prebuild for iOS...")
    sh("npx expo prebuild --clean --platform ios")

    # Force manual code signing in Xcode project
    # expo prebuild generates projects with automatic signing by default
    # We need to explicitly set CODE_SIGN_STYLE=Manual to prevent Xcode
    # from looking for Development provisioning profiles
    UI.message("Setting CODE_SIGN_STYLE to Manual in Xcode project...")
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "ios/NamVitInternal.xcodeproj",
      team_id: "9F77J83SKT",
      targets: ["NamVitInternal"],
      code_sign_identity: "iPhone Distribution",
      profile_name: nil  # Will be set later based on build type
    )
  end

  desc "Build and upload to TestFlight (Production)"
  lane :build_upload_testflight do
    api_key = load_asc_api_key
    setup_ci if ENV['CI']

    increment_build_number_lane
    run_prebuild

    # Get code signing - try readonly first, generate if missing
    begin
      match(
        type: 'appstore',
        readonly: true,
        verbose: true,
        api_key: api_key,
        keychain_name: ENV['CI'] ? "fastlane_tmp_keychain" : nil,
        keychain_password: ""
      )
    rescue => ex
      if ex.message.include?("No code signing identity found") || ex.message.include?("No matching provisioning profiles found")
        UI.important("No certificates or provisioning profiles found, generating new ones...")
        match(
          type: 'appstore',
          readonly: false,
          verbose: true,
          api_key: api_key,
          keychain_name: ENV['CI'] ? "fastlane_tmp_keychain" : nil,
          keychain_password: ""
        )
      else
        raise ex
      end
    end

    # Set provisioning profile for App Store build
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "ios/NamVitInternal.xcodeproj",
      team_id: "9F77J83SKT",
      targets: ["NamVitInternal"],
      build_configurations: ["Release"],
      profile_name: "match AppStore vn.dienlanhnamviet.internal",
      code_sign_identity: "Apple Distribution"
    )

    # Build app
    build_app(
      workspace: "ios/NamVitInternal.xcworkspace",
      scheme: "NamVitInternal",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "nvinternal.ipa",
      clean: true,
      xcargs: "DEVELOPMENT_TEAM=9F77J83SKT CODE_SIGN_STYLE=Manual PROVISIONING_PROFILE_SPECIFIER='match AppStore vn.dienlanhnamviet.internal'",
      export_xcargs: "-allowProvisioningUpdates",
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "vn.dienlanhnamviet.internal" => "match AppStore vn.dienlanhnamviet.internal"
        },
        signingStyle: "manual",
        teamID: "9F77J83SKT"
      }
    )

    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      distribute_external: false
    )

    UI.success("âœ… Successfully uploaded build to TestFlight!")
  end

  desc "Build for staging/preview and optionally upload to TestFlight"
  lane :build_staging do |options|
    api_key = load_asc_api_key
    setup_ci if ENV['CI']

    increment_build_number_lane
    run_prebuild

    # Determine if we should upload to TestFlight
    should_upload = options[:upload] || ENV['UPLOAD_TO_TESTFLIGHT'] == 'true'

    # Use App Store provisioning if uploading to TestFlight, otherwise Ad Hoc
    provisioning_type = should_upload ? 'appstore' : 'adhoc'
    profile_name = should_upload ? "match AppStore vn.dienlanhnamviet.internal" : "match AdHoc vn.dienlanhnamviet.internal"
    export_method = should_upload ? 'app-store' : 'ad-hoc'

    UI.message("ðŸ“¦ Building staging with #{provisioning_type} provisioning")
    UI.message("ðŸ“¤ Upload to TestFlight: #{should_upload}")

    # Get code signing - try readonly first, generate if missing
    begin
      match(
        type: provisioning_type,
        readonly: true,
        verbose: true,
        api_key: api_key,
        keychain_name: ENV['CI'] ? "fastlane_tmp_keychain" : nil,
        keychain_password: ""
      )
    rescue => ex
      if ex.message.include?("No code signing identity found") || ex.message.include?("No matching provisioning profiles found")
        UI.important("No certificates or provisioning profiles found, generating new ones...")
        match(
          type: provisioning_type,
          readonly: false,
          verbose: true,
          api_key: api_key,
          keychain_name: ENV['CI'] ? "fastlane_tmp_keychain" : nil,
          keychain_password: ""
        )
      else
        raise ex
      end
    end

    # Set provisioning profile
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "ios/NamVitInternal.xcodeproj",
      team_id: "9F77J83SKT",
      targets: ["NamVitInternal"],
      build_configurations: ["Release"],
      profile_name: profile_name,
      code_sign_identity: "Apple Distribution"
    )

    build_app(
      workspace: "ios/NamVitInternal.xcworkspace",
      scheme: "NamVitInternal",
      configuration: "Release",
      export_method: export_method,
      output_directory: "./build",
      output_name: "nvinternal-staging.ipa",
      clean: true,
      xcargs: "DEVELOPMENT_TEAM=9F77J83SKT CODE_SIGN_STYLE=Manual PROVISIONING_PROFILE_SPECIFIER='#{profile_name}'",
      export_xcargs: "-allowProvisioningUpdates",
      export_options: {
        method: export_method,
        provisioningProfiles: {
          "vn.dienlanhnamviet.internal" => profile_name
        },
        signingStyle: "manual",
        teamID: "9F77J83SKT"
      }
    )

    UI.success("âœ… Successfully built staging IPA!")

    # Upload to TestFlight if requested
    if should_upload
      UI.message("ðŸ“¤ Uploading staging build to TestFlight...")
      upload_to_testflight(
        skip_waiting_for_build_processing: true,
        skip_submission: true,
        distribute_external: false,
        api_key: api_key
      )
      UI.success("âœ… Successfully uploaded staging build to TestFlight!")
    else
      UI.message("â­ï¸  Skipping TestFlight upload (use upload:true or UPLOAD_TO_TESTFLIGHT=true to upload)")
    end
  end
end

platform :android do
  desc "Increment build number"
  lane :increment_build_number_lane do
    build_number = ENV["BUILD_NUMBER"] || "1"
    UI.message("Using build number: #{build_number}")

    # Export for expo prebuild
    ENV["BUILD_NUMBER"] = build_number
  end

  desc "Run Expo Prebuild for Android"
  lane :run_prebuild do
    UI.message("Running expo prebuild for Android...")
    sh("npx expo prebuild --clean --platform android")
  end

  desc "Build and upload to Play Store (Internal Track)"
  lane :build_upload_playstore do
    increment_build_number_lane
    run_prebuild

    # Build AAB
    gradle(
      task: "bundle",
      build_type: "Release",
      project_dir: "android/",
      properties: {
        "android.injected.signing.store.file" => File.expand_path("../@duongdev__nv-internal.jks"),
        "android.injected.signing.store.password" => ENV["ANDROID_KEYSTORE_PASSWORD"],
        "android.injected.signing.key.alias" => ENV["ANDROID_KEY_ALIAS"] || "nv-internal",
        "android.injected.signing.key.password" => ENV["ANDROID_KEY_PASSWORD"]
      },
      flags: "-x lint -x lintVitalRelease -x lintVitalAnalyzeRelease --no-daemon"
    )

    # Upload to Play Store
    upload_to_play_store(
      track: 'internal',
      aab: 'android/app/build/outputs/bundle/release/app-release.aab',
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )

    UI.success("âœ… Successfully uploaded build to Play Store Internal Track!")
  end

  desc "Build APK for testing"
  lane :build_apk do
    increment_build_number_lane
    run_prebuild

    gradle(
      task: "assemble",
      build_type: "Release",
      project_dir: "android/",
      properties: {
        "android.injected.signing.store.file" => File.expand_path("../@duongdev__nv-internal.jks"),
        "android.injected.signing.store.password" => ENV["ANDROID_KEYSTORE_PASSWORD"],
        "android.injected.signing.key.alias" => ENV["ANDROID_KEY_ALIAS"] || "nv-internal",
        "android.injected.signing.key.password" => ENV["ANDROID_KEY_PASSWORD"]
      },
      flags: "-x lint -x lintVitalRelease -x lintVitalAnalyzeRelease --no-daemon"
    )

    UI.success("âœ… Successfully built APK!")
  end
end
