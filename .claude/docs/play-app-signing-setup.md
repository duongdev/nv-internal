# Play App Signing Enrollment Checklist

**Date**: 2025-11-13
**App**: Nam Vi·ªát Internal (vn.dienlanhnamviet.internal)
**Status**: To be completed on first AAB upload

---

## What is Play App Signing?

Play App Signing is Google's recommended approach where:
- **Google manages** the app signing key (used to sign APKs on user devices)
- **You manage** the upload key (used to sign AABs before uploading)
- If you lose your upload key, Google can reset it
- Required for publishing App Bundles (AAB format)

**Important**: Once enrolled, you cannot switch back. But this is the recommended approach for all apps.

---

## Prerequisites ‚úÖ

Before enrolling, ensure you have:

- [x] Android keystore file (`@duongdev__nv-internal.jks`)
- [x] Keystore passwords stored securely (in GitHub Secrets)
- [x] AAB file ready to upload (will be generated by CI/CD)
- [x] Google Play Console account with app created
- [x] Service account with Play Console permissions

---

## Enrollment Process

### Option A: Automatic Enrollment (Recommended for New Apps)

**When**: During your first AAB upload to Play Console

1. **Build your first AAB**:
   ```bash
   # Via GitHub Actions (recommended)
   gh workflow run build-deploy.yml --ref feature/android-release \
     -f platform=android \
     -f environment=production \
     -f submit=false  # Build only, don't submit yet
   ```

2. **Download the AAB** from GitHub Actions artifacts:
   - Go to: https://github.com/duongdev/nv-internal/actions
   - Click on the workflow run
   - Download `android-build-logs-XX` artifact
   - Extract `app-release.aab`

3. **Upload to Play Console**:
   - Go to: https://play.google.com/console
   - Select your app (or create if not done)
   - Navigate to: **Release ‚Üí Production ‚Üí Create new release** (or Internal testing)
   - Upload the `app-release.aab`

4. **Enroll in Play App Signing** (Google will prompt):
   - ‚úÖ Click "Continue" when prompted about Play App Signing
   - ‚úÖ Google automatically enrolls your app
   - ‚úÖ Your current keystore becomes the "upload key"
   - ‚úÖ Google generates and manages the "app signing key"

5. **Verify enrollment**:
   - Go to: **Setup ‚Üí App integrity ‚Üí App signing**
   - You should see two keys:
     - **App signing key certificate** (managed by Google)
     - **Upload key certificate** (your keystore)

### Option B: Manual Enrollment (If Needed)

**When**: If you want to enroll before uploading an AAB

1. **Go to Play Console**:
   - Navigate to: **Setup ‚Üí App integrity ‚Üí App signing**

2. **Choose enrollment method**:
   - **Option 1**: Let Google generate your app signing key (easiest)
     - Click "Continue"
     - Google creates a new app signing key
     - Your keystore becomes the upload key

   - **Option 2**: Use existing Java keystore (if you have a legacy app)
     - Export your current key to PEM format
     - Upload it to Google
     - Create a new upload key

3. **For new apps, choose Option 1** (Google generates)

---

## Verification Checklist

After enrollment, verify the following:

### In Play Console

- [ ] Go to **Setup ‚Üí App integrity ‚Üí App signing**
- [ ] Verify "App signing key certificate" shows:
  - SHA-1 certificate fingerprint
  - Status: "Managed by Google"
- [ ] Verify "Upload key certificate" shows:
  - Your keystore's SHA-1 fingerprint
  - Note: You can verify this matches your local keystore

### Verify Your Local Keystore SHA-1

```bash
cd apps/mobile

# Extract SHA-1 from your keystore
keytool -list -v -keystore @duongdev__nv-internal.jks -alias nv-internal \
  -storepass:env ANDROID_KEYSTORE_PASSWORD

# Look for "SHA1:" in the output
# This should match the "Upload key certificate" SHA-1 in Play Console
```

### Update Documentation

- [ ] Document the SHA-1 fingerprints for reference
- [ ] Store app signing key info securely (from Play Console)
- [ ] Update team documentation with Play App Signing status

---

## Important Notes

### ‚úÖ Benefits

1. **Key recovery**: If upload key is lost, Google can reset it
2. **Security**: App signing key never leaves Google's infrastructure
3. **Required**: Mandatory for App Bundle (AAB) format
4. **Updates**: Seamless app updates without user reinstallation

### ‚ö†Ô∏è Important Warnings

1. **One-way decision**: Cannot switch back to manual signing after enrollment
2. **Upload key is critical**: While Google can reset it, avoid losing it
3. **First upload matters**: The signing configuration is set on first upload
4. **Package name locked**: Cannot change package name after publishing

### üîê Security Best Practices

1. **Backup your upload key**:
   - Store `@duongdev__nv-internal.jks` in multiple secure locations
   - Already stored in GitHub Secrets ‚úÖ
   - Consider encrypted backup in password manager

2. **Protect keystore passwords**:
   - Never commit to repository ‚úÖ
   - Stored in GitHub Secrets ‚úÖ
   - Store in team password manager

3. **Document SHA-1 fingerprints**:
   - Needed for Firebase, Google Maps, Facebook SDK integration
   - Both upload key and app signing key fingerprints

---

## SHA-1 Fingerprints (To Be Filled After Enrollment)

### Upload Key (Your Keystore)
```
SHA-1: [Run keytool command above to get this]
SHA-256: [Also in keytool output]
```

### App Signing Key (Google Managed)
```
SHA-1: [Copy from Play Console after enrollment]
SHA-256: [Copy from Play Console after enrollment]
```

**Why you need both**:
- **Upload key SHA-1**: Used during local development/debugging
- **App signing key SHA-1**: Used for production app on user devices
- Both may need to be registered with third-party services (Firebase, Google APIs)

---

## Integration with CI/CD

### Current Setup ‚úÖ

Your GitHub Actions workflow already handles signing correctly:

1. **Keystore is decoded** from base64 secret
2. **Gradle signs** the AAB with your keystore (upload key)
3. **Fastlane uploads** the signed AAB to Play Console
4. **Google re-signs** with the app signing key before distribution

No changes needed to your CI/CD after enrollment!

### Verification

After first successful upload via CI:

```bash
# Trigger a build
gh workflow run build-deploy.yml --ref main \
  -f platform=android \
  -f environment=production \
  -f submit=true

# Monitor the build
gh run watch

# Verify in Play Console
# Go to: Release ‚Üí Production/Internal ‚Üí Review release
```

---

## Troubleshooting

### "Upload certificate doesn't match"

**Problem**: Trying to upload AAB signed with wrong keystore

**Solution**:
1. Verify GitHub Secret `ANDROID_KEYSTORE_BASE64` is correct
2. Check `ANDROID_KEY_ALIAS` matches your keystore alias
3. Verify passwords in secrets are correct

### "App signing key already used by another app"

**Problem**: Trying to reuse a signing key from another app

**Solution**: Each app must have a unique app signing key. Create a new keystore for this app.

### Need to register both SHA-1s with third-party services

**When**: Integrating Firebase, Google Sign-In, Facebook SDK, etc.

**Solution**:
1. Add **both** SHA-1 fingerprints (upload key + app signing key)
2. For Firebase: Add in Firebase Console ‚Üí Project Settings ‚Üí Your apps
3. For Google APIs: Add in Google Cloud Console ‚Üí Credentials

---

## Next Steps After Enrollment

1. **Document fingerprints** (fill in sections above)
2. **Update third-party services** (Firebase, Google APIs) with app signing key SHA-1
3. **Test first production build** via CI/CD
4. **Verify app installs and updates** correctly
5. **Backup upload key** to secure location (already in GitHub Secrets ‚úÖ)

---

## References

- [Google Play App Signing Official Docs](https://support.google.com/googleplay/android-developer/answer/9842756)
- [Android App Signing Guide](https://developer.android.com/studio/publish/app-signing)
- [Expo App Credentials](https://docs.expo.dev/app-signing/app-credentials/)
- Your build runbook: `.claude/docs/BUILD-DEPLOY-RUNBOOK.md`
- Your keystore: `apps/mobile/@duongdev__nv-internal.jks`

---

## Status Tracking

- [ ] **Step 1**: Build first AAB
- [ ] **Step 2**: Upload to Play Console (Internal/Production track)
- [ ] **Step 3**: Enroll in Play App Signing (automatic prompt)
- [ ] **Step 4**: Verify enrollment in Play Console
- [ ] **Step 5**: Document SHA-1 fingerprints
- [ ] **Step 6**: Update third-party service configurations
- [ ] **Step 7**: Test first CI/CD deployment with submission
- [ ] **Step 8**: Verify app installation from Play Console

---

**Next Action**: Build first AAB and upload to Play Console to trigger enrollment.
